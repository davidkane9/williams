---
title: "Williams College Faculty and Graduates"
author: "Karan Tibrewal and David Kane"
date: "`r Sys.Date()`"
output: html_document
runtime: shiny
---


```{r, echo = FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)
```


## Introduction

This document provides an overview of the data available in the wiliamsmetrics package. We have data on the faculty and graduates of Williams College from the 1999--2000 academic year through 2015--2016.

```{r}
library(dplyr)
library(stringr)
library(ggplot2)
library(williamsmetrics)
library(shiny)
library(shinydashboard)
data(graduates_details)
x <- graduates_details
```


## Graduates

There were `r dim(x)[1]` graduates of Williams from `r min(x$year)` through `r max(x$year)`. The number of graduates averages about `r round(mean(table(x$year)))` per year. The largest class was `r as.numeric(tail(sort(table(x$year)), n = 1))` in 
`r as.numeric(names(tail(sort(table(x$year)), n = 1)))`. The smallest was 
`r as.numeric(head(sort(table(x$year)), n = 1))` in
`r as.numeric(names(head(sort(table(x$year)), n = 1)))`. 

### Names

Names are interesting. The graduate with the longest name is 
`r x %>% select(year, full.name) %>% filter(min_rank(-nchar(full.name)) < 2) %>% as.character() %>% tail(1)` 
from the class of 
`r x %>% select(year, full.name) %>% filter(min_rank(-nchar(full.name)) < 2) %>% as.character() %>% head(1)`. The students with the shortest names are:

```{r, echo = FALSE}
x %>% select(year, full.name) %>% filter(min_rank(nchar(full.name)) < 2) %>% as.data.frame()
```

The students with the longest last name and first name are:

```{r, echo=FALSE}
x %>% select(year, full.name, first.name, last.name) %>% filter(min_rank(-nchar(first.name)) < 2 | min_rank(-nchar(last.name)) < 2) %>% select(-first.name, -last.name) %>% as.data.frame()
```

The students with at least 5 separate parts to their full names are:

```{r, echo=FALSE}
x[str_split(x$full.name, " ", simplify = TRUE)[,5] != "",] %>% select(year, full.name) %>% as.data.frame()
```

### Gender

The course catalogs do not provide the gender of the graduates, so we estimate it by using the [gender](https://cran.r-project.org/web/packages/gender/gender.pdf) and [genderizeR](https://cran.r-project.org/web/packages/genderizeR/index.html) package. 

These packages predict gender on the basis of names. We first use the `gender` package to predict gender according to the first and middle names of graduates. Alas, the `gender` package focuses heavily on American names, and therefore, this approach is ineffective for non-American names like DoHyun and Qiang. 

To account for this shortcoming, we supplement the `gender` package with the `genderizeR` package which provides more global coverage. However, this is a paid service that limits free access. So, we used it once and then saved the results.

Our gender variable looks like:

```{r}
table(x$gender, exclude = NULL)
```


```{r}
x %>% filter(is.na(gender)) %>% select(first.name, gender) %>% group_by(first.name, gender) %>% summarize(count = n()) %>% arrange(desc(count)) %>% as.data.frame() %>% head(12)
```

Most of the NAs for gender are due to unique first names, names that appear only once amoung the `r dim(x)[1]` graduates. Eventually, we might fix some of these by hand. But, for now, we see no reason why these NA should bias any of the later analysis. 

```{r}
x %>% select(year, gender) %>% count(year, gender) %>% mutate(percentage = n/sum(n)) %>% ggplot(aes(year, percentage, color = gender)) + geom_line()
```

### Race

We use the wru package to estimate race. The totals for the entire data set are:

```{r}
table(x$race, exclude = NULL)
```

Judging by the the College's public statements and Common Data Set releases, we are significantly overestimating the percentage of white students.

```{r}
round(prop.table(table(x$race)), 3)
```

The "Other" category includes only a handful of students:

```{r}
x %>% filter(race == "Other") %>% select(full.name, race) %>% as.data.frame()
```

There is no publicly available source for the racial breakdown of the graduating class. (True? Check NEPS.) The 2015--2016 Common Data Set [reports](https://provost.williams.edu/files/williams_cds_1516_w_tuition.pdf) that, among all degree-seeking undergraduates at Williams, `r round(243/2065, 2)` Asian, `r round(157/2065, 2)` were 
Black, `r round(261/2065, 2)` Hispanic, `r round(1106/2065, 2)` White, and `r round((161 + 4 + 133)/2065, 2)` in other categories, including Nonresident Aliens, American Indian or Two-or-more races.

Our estimates for non-White students are too low. First, we don't even find the same number of Asian/Black/Hispanic students are we know to be at Williams among the US citizen portion of the population. Second, we categorize some/many of the students in the other categories (most importantly the international and multi-racial students) as being in non-White categories even though they are not so classified by Williams.

As an example, we classify Paige Lauren Whidbee '16 as Black. She is the only Phi Beta Kappa member of the class of 2016 that we so classify. However, according to this [photo](http://ephsports.williams.edu/sports/wgolf/2014-15/bios/whidbee_paige_2xmt?view=bio), she probably isn't African-American.


```{r}
x %>% select(year, race) %>% count(year, race) %>% mutate(percentage = n/sum(n)) %>% ggplot(aes(year, percentage, color = race)) + geom_line()
```

###Latin Honors, Phi Beta Kappa, and Sigma Xi

The College awards latin honors by the following rules: 

* 35% of the graduating class -- Bachelor of Arts cum laude or higher
* 15% of the graduating class -- Bachelor of Arts magna cum laude or higher
* 2% of the graduating class -- Bachelor of Arts summa cum laude

The remaining 65% receive no honors. 

```{r}
round(prop.table(table(graduates$latin.honors))*100, 2)
```

The college inducts students of the highest academic standing to the [Phi Beta Kappa Society](http://web.williams.edu/admin/registrar/faq/distinct.html). At the end of the junior year, all students in the highest five percent of the class, ranked by cumulative grade point average, shall be eligible for election.  At the end of their senior year, students in the 12.5 percent of the class, excluding those already elected, are eligible for election.

```{r}
x <- filter(graduates, Phi.Beta.Kappa) %>% group_by(year) %>% summarise(n = n())
x$n <- x$n / table(graduates$year)
x %>% select(year, percent = n)
```

The [Williams College Sigma Xi Chapter](https://science.williams.edu/student-faculty-research/sigma-xi/) recognizes students "graduating science students who have demonstrated exceptional ability and promise for further contributions to the advancement of scientific research"

```{r}
x <- filter(graduates, Sigma.Xi) %>% group_by(year) %>% summarise(n = n())
x$n <- x$n / table(graduates$year)
x %>% select(year, percent = n)
```

Since colleges are (rightly!) protective about GPA data, latin honors and membership of these societies can be effective proxies for academic excellence. The following `Shiny` App explores the relationship between them and gender and race:



```{r}
header <- dashboardHeader(title = "Williams College")

sidebar <- dashboardSidebar(
  sidebarMenu(
    menuItem("Summa Cum Laude", tabName = "summa", selected = TRUE),
    menuItem("Magna Cum Laude", tabName = "magna"),
    menuItem("Cum Laude", tabName = "cum"),
    menuItem("None", tabName = "none"),
    menuItem("Phi Betta Kappa", tabName = "PBK"),
    menuItem("Sigma Xi", tabName = "SX")

  )
)
body <- dashboardBody(
  tabItems(
    tabItem(tabName = "summa",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("summaGender"),
                  sliderInput("timelineSummaG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("raceSummaG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"),
                                     inline = TRUE)
              )),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("summaRace"),
                  sliderInput("timelineSummaR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderSummaR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"),
                                     inline = TRUE)
              )
            )


    ),

    tabItem(tabName = "magna",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("magnaGender"),
                  sliderInput("timelineMagnaG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("raceMagnaG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"),
                                     inline = TRUE)
              )),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("magnaRace"),
                  sliderInput("timelineMagnaR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderMagnaR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"),
                                     inline = TRUE)
              )
            )


    ),

    tabItem(tabName = "cum",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("cumGender"),
                  sliderInput("timelineCumG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("raceCumG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"),
                                     inline = TRUE)
              )),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("cumRace"),
                  sliderInput("timelineCumR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderCumR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"),
                                     inline = TRUE)
              )
            )


    ),

    tabItem(tabName = "none",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("noneGender"),
                  sliderInput("timelineNoneG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("raceNoneG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"),
                                     inline = TRUE)
              )),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("noneRace"),
                  sliderInput("timelineNoneR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderNoneR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"),
                                     inline = TRUE)
              )
            )


    ),
    tabItem(tabName = "PBK",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("PBKGender"),
                  sliderInput("timelinePbkG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("racePbkG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"),
                                     inline = TRUE)
              )),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("PBKRace"),
                  sliderInput("timelinePbkR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderPbkR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"), 
                                     inline = TRUE)
              )
            )


    ),

    tabItem(tabName = "SX",
            fluidRow(
              box(width = 300, title = "Explore by Gender",
                  plotOutput("SXGender"),
                  sliderInput("timelineSXG", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("raceSXG", "Races to show:",
                                     c("White",
                                       "Black",
                                       "Asian",
                                       "Hispanic",
                                       "Other"), selected = c("White", "Asian", "Black", "Hispanic", "Other"), 
                                     inline = TRUE)
              )
            ),
            fluidRow(

              box(width = 300, title = "Explore by Race",
                  plotOutput("SXRace"),
                  sliderInput("timelineSXR", "Timeline:", min(graduates$year), max(graduates$year),
                              value = c(min(graduates$year), max(graduates$year))),
                  checkboxGroupInput("genderSXR", "Genders to show:",
                                     c("Male" = "male",
                                       "Female" = "female"), selected = c("male", "female"),
                                     inline = TRUE)
              )
            )
    )
  )
)

renderGenderPlot <- function(timeline, races, hon){
  graduates$latin.honors[which(is.na(graduates$latin.honors))] <- "None"
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], race %in% races, !is.na(gender), latin.honors == hon) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(gender, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, color = gender)) + geom_line() + labs(x = "Year", y = "Percent")
}

renderRacePlot <- function(timeline, genders, hon){
  print(hon)
  graduates$latin.honors[which(is.na(graduates$latin.honors))] <- "None"
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], gender %in% genders, !is.na(race), latin.honors == hon) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(race, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, fill = race)) + geom_bar(stat = "identity", position = "dodge") + labs(x = "Year", y = "Percent")
}

renderPBKGenderPlot <- function(timeline, races){
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], race %in% races, !is.na(gender), Phi.Beta.Kappa) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(gender, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, fill = gender)) + geom_bar(stat = "identity", position = "dodge") + labs(x = "Year", y = "Percent")
}

renderPBKRacePlot <- function(timeline, genders){
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], gender %in% genders, !is.na(race), Phi.Beta.Kappa) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(race, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, fill = race)) + geom_bar(stat = "identity", position = "dodge") + labs(x = "Year", y = "Percent")
}



renderSXRacePlot <- function(timeline, genders){
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], gender %in% genders, !is.na(race), Sigma.Xi) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(race, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, fill = race)) + geom_bar(stat = "identity", position = "dodge") + labs(x = "Year", y = "Percent")
}

renderSXGenderPlot <- function(timeline, races){
  x <- graduates %>% dplyr::filter(year >= timeline[1], year <= timeline[2], race %in% races, !is.na(gender), Sigma.Xi) %>%
    dplyr::group_by(year) %>% mutate(total = n()) %>% group_by(gender, total, add = TRUE) %>% dplyr::mutate(percent = n()/ total * 100)
  ggplot(x, aes(x = year, y = percent, fill = gender)) + geom_bar(stat = "identity", position = "dodge") + labs(x = "Year", y = "Percent")
}


ui <- dashboardPage(skin = "purple", header, sidebar, body)
server <- function(input, output) {

  output$summaGender <- renderPlot({
    renderGenderPlot(input$timelineSummaG, input$raceSummaG, "Summa Cum Laude")
  })
  output$summaRace <- renderPlot({
    renderRacePlot(input$timelineSummaR, input$genderSummaR, "Summa Cum Laude")
  })

  output$magnaGender <- renderPlot({
    renderGenderPlot(input$timelineMagnaG, input$raceMagnaG, "Magna Cum Laude")
  })
  output$magnaRace <- renderPlot({
    renderRacePlot(input$timelineMagnaR, input$genderMagnaR, "Magna Cum Laude")
  })

  output$cumGender <- renderPlot({
    renderGenderPlot(input$timelineCumG, input$raceCumG, "Cum Laude")
  })
  output$cumRace <- renderPlot({
    renderRacePlot(input$timelineCumR, input$genderCumR, "Cum Laude")
  })

  output$noneGender <- renderPlot({
    renderGenderPlot(input$timelineNoneG, input$raceNoneG, "None")
  })
  output$noneRace <- renderPlot({
    renderRacePlot(input$timelineNoneR, input$genderNoneR, "None")
  })
    output$PBKGender <- renderPlot({
    renderPBKGenderPlot(input$timelinePbkG, input$racePbkG)
  })
  output$PBKRace <- renderPlot({
    renderPBKRacePlot(input$timelinePbkR, input$genderPbkR)
  })

  output$SXGender <- renderPlot({
    renderSXGenderPlot(input$timelineSXG, input$raceSXG)
  })
  output$SXRace <- renderPlot({
    renderSXRacePlot(input$timelineSXR, input$genderSXR)
  })
}


shinyApp(ui, server, options = list(height = 1350, width = 850))

```

Notice that Summa Cum Laude honors are fairly evenly distributed between the two genders, except for in some years like `2003, 2004, 2005,` and `2011` where males significantly out perform females. Further, almost always there is a higher percentage of females that receive Cum Laude honors than their male counterparts, and almost always a higher percentage of males who receive no latin honors. This view of the data is consistent with the [theory](http://www.sciencedirect.com/science/article/pii/S0160289606001115) that on average, men and women are equally intelligent, but male intelligence has a higher variance. 

In a decade and half worth data, we do not classify a single graduate receiving Summa Cum Laude honors as Hispanic. Is this, in fact, true? Indeed, we performed Google searches on Summa Cum Laude graduates over the last 10 years (Good news: Finishing on the top 2% of your class at Williams almost certainly garauntees that you are very Google-able), but we do not find any data to suggest otherwise. 

Black graduates follow a similar pattern. In fact, in the last 10 years, we classify 2 graduates receiving Summa Cum Laude as Black. Unfortonately, neither of the two, [Blacke Mackall](http://ephsports.williams.edu/sports/mten/2014-15/bios/mackall_blake_n3y8) nor [Erika Williams](https://neuroscience.williams.edu/files/2012/10/ErikaWilliams2.jpg), is in fact black. Then, as far as we can tell, no Black Williams student graduated with Suma Cum Laude in the last decade. 

Early Phi Beta Kappa

Asian Graduates? 


Across divisions, how races/ gender are "successful". 

```{r}
graduates$asian <- graduates$race == "Hispanic"
graduates$summa <- graduates$latin.honors == "Summa Cum Laude"
l <- lm(graduates$summa~graduates$asian + graduates$major)

```




