---
title: "Williams College Faculty and Graduates Data Manual"
author: "Karan Tibrewal and David Kane"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html: default
  tufte::tufte_handout:
    citation_package: natbib
    latex_engine: xelatex
  tufte::tufte_book:
    citation_package: natbib
    latex_engine: xelatex
---


```{r, echo = FALSE}
knitr::opts_chunk$set(tidy = FALSE,
                      echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE)
```


# Introduction

```{r}
library(williamsmetrics)
library(dplyr)

```

The purpose of this document is to document the procedure for the creation of the faculty and graduate datasets. The data is collected from archives of the College's [Course Catalogs](http://web.williams.edu/admin/registrar//catalog/archive.html), from `r min(graduates$year)` to `r max(graduates$year)`. 

##Graduates

We begin with graduates. Our package provides two datasets: `graduates` and `graduates_details`. The `graduates` dataset provides the following variables: 

```{r}
names(graduates) %>% as.data.frame()
```

The `graduates_details` dataset expands on the above, and provides the following extra columns: 

```{r}
 names(graduates_details)[! names(graduates_details) %in%  names(graduates)] %>% as.data.frame()
```

For details on these variables, try `?graduates` or `?graduates_details` on your R console.    

The datasets are created by scraping data from the Course Catalogs which are saved as `.txt` files in the `inst/extdata` directory. These files follow the naming convention of `graduates-<YEAR (YYYY)>-<YEAR + 1 (YYYY)>`, where `YEAR` is the year for the relevant catalog. For example, the text file with information about graduates from 2000 is saved as `graduates-2000-2001.txt`. For convenience, we only save the pages containing information about graduates from the course catalogs to these files. 

Let us look inside these text files. The following is an abstract from `graduates-2000-2001.txt`. We will use it as an example to demonstrate the data munging procedure for gradutes: 

```
Bachelor of Arts, Summa Cum Laude
*DoHyun Tony Chung, with honors in Political Economy
+*Rebecca Tamar Cover, with highest honors in Astrophysics
*Amanda Bouvier Edmonds
*Douglas Bertrand Marshall, with highest honors in Philosophy
+*Michelle Pacholec, with honors in Chemistry
*Grace Martha Pritchard, with honors in English
*Michael Vernon Ramberg
+*Taylor Frances Schildgen, with highest honors in Geosciences
*Qiang Sun
*Laura Susan Trice
*Max McMeekin Weinstein, with highest honors in Philosophy
*Catherine Anne Williams, with highest honors in History
Bachelor of Arts, Magna Cum Laude
David Scott Adams
*Julianne Humphrey Anderson
*Michael Zubrow Barkin
Robert Charles Blackstone
*Marlin Chu
*Sarah Ann Cohen, with highest honors in English
Mark Douglas Conrad
*Ellen Griswold Cook
*Mary Bowman Cummins
*Yana Dadiomova
```
###gather_graduates()

This function brings together the information on all Williams graduates for the years that we have downloaded the data in the package. It
also adds Latin honors, Phi Betta Kappa, Sigma Xi, and birth year information.

The first step is to read in the information from the text files. Once the raw information for graduates is available, we can immediately infer some data points:  

* **Latin Honors:** The information for graduates in the text files are grouped by their Latin honors. Notice the lines reading "Bachelor of Arts, Summa Cum Laude" and "Bachelor of Arts, Magna Cum Laude" in the above example. All graduates between these lines graduated with Summa Cum Laude. Similarly, all graduates between the lines "Bachelor of Arts, Magna Cum Laude" and "Bachelor of Arts, Cum Laude" graduated with Magna Cum Laude. As of such, we classify Latin honors for each graduate as one of Summa Cum Laude, Magna Cum Laude, Cum Laude, or NA.   
* **Phi Betta Kappa:** The course catalogs indicate membership of Phi Betta Kappa by a "*" before the graduate's name. 
* **Sigma Xi:** The course catalogs indicate membership of Phi Betta Kappa by a "+" before the graduate's name. 
* **Birth Year:** We calculate the birth year using heuristic of undegraduate graduation year minus 22. 



```{r, echo = TRUE}
x <- gather_graduates()
x %>% as.data.frame() %>% head(15)
```


###add_graduate_names()

We infer `first.name`, `middle.name`, and `last.name` for graduates from the `raw.text` column from above. The names are always provided before the first comma. 

A big problem is that, although the vast majority of people have 3 names, hundreds have just 2 or 4 and a handful have 5, e.g., Alfonso Rodrigo González del Riego! One (so far!) even has 6: Chloë Iambe Naomi Illyria Feldman Emison. It is tricky dealing with last names that (obviously?) include more than one word, like González del Riego.

The first name is easy: it is the first word in the name. Ignoring the complication that last names might be multiple words, we (in some cases, incorrectly!) assume it to be the last word in the name. If there are other words between the first and last name, they are classified as the middle name. 

```{r, echo = TRUE}
x <- add_graduate_names(x)
x %>% dplyr::select(raw.text, first.name, middle.name, last.name) %>% as.data.frame() %>% head(15)
```

###add_graduate_honors

This function takes as input a data frame which includes the raw text associated with each graduate. It returns that data frame along with
six new columns (`honor.1`, `honor.2`, `honor`, `major.1`, `major.2`, and `major`) associated with department honors. Department honors are conferred on graduates who write a thesis during their senior year. 

Information about department honors is always provided after the first comma in the raw text. A graduate may write two theses, in which case, information about the two are seperated by a comma. 

* `honor.1` and `major.1`: These fields describe the first department honor conferred on the graduate as per the course catalogs. The `honor.1` field provides the distinction for the honor as one of "honors", "highest honors" , or NA. The `major.1` field provides the department under which the thesis was written. It is NA if the graduate has not written a thesis.     
* `honor.2` and `major.2`: These fields describe the second department honor conferred on the graduate as per the course catalogs. The `honor.2` field provides the distinction for the honor as one of "honors", "highest honors" , or NA. The `major.2` field provides the department under which the second thesis was written. It is NA if the graduate has not written a second thesis.
* `honor` and `major`: We simplify department information as the highest honor received by the graduate, and the corresponding major.   

```{r, echo = TRUE}
x <- add_graduate_honors(x)
x %>% dplyr::select(raw.text, honor.1, major.1, honor.2, major.2, honor, major) %>% as.data.frame() %>% head(15)
```

###add_gender_graduates

The course catalogs do not provide the gender of the graduates, so we estimate it by using the [gender](https://cran.r-project.org/web/packages/gender/gender.pdf) and [genderizeR](https://cran.r-project.org/web/packages/genderizeR/index.html) package. 

These packages predict gender on the basis of names. We first use the `gender` package to predict gender according to the first and middle names of graduates. Alas, the `gender` package focuses heavily on American names, and therefore, this approach is ineffective for non-American names like DoHyun and Qiang. 

`r tufte::margin_note("The results from genderizeR are saved as data frame in sys.rda in the R directory as genderizeR.graduates. While adding information about subsequent years, this data set must be regenerated.")`

To account for this shortcoming, we supplement the `gender` package with the `genderizeR` package which provides more global coverage. However, this is a paid service that limits free access. So, we used it once and then saved the results. 

```{r, echo = TRUE}
x <- add_gender_graduates(x)
x %>% dplyr::select(first.name, middle.name, gender) %>% as.data.frame() %>% head(15)
```

###add_race


We use the [wru](https://cran.r-project.org/web/packages/wru/wru.pdf) package to estimate race on the basis of last name. The package utilizes the Bayes' Rule to compute the posterior probability from Voter Registration Records of each racial category for any given individual's name. We predict the individual's race as the racial category with the highest prosterior probability. 

```{r, echo = TRUE}
x <- add_race(x)
x %>% dplyr::select(last.name, p_whi, p_bla, p_his, p_asi,p_oth,race) %>% as.data.frame() %>% head(15)
```

###Summary

The functions described above are called from the `create_graduates` function, that takes in a logical parameter `complete`. Calling `create_graduates` with `complete = TRUE` produces the `graduates_details` data set. If `complete = FALSE`, `create_graduates` trims a dozen or so extraneous columns from `graduates_details` to produce the `graduates` dataset.

`graduates <- create_graduates(complete = FALSE)`             
`graduates_details <- create_graduates(complete = TRUE)`


